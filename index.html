<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Sound Level Meter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.1/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.1/addons/p5.sound.min.js"></script>
  </head>
  <body>
  <script>
    var mic;
    let canvasWidth = 400;
    let canvasHeight = 300;
    let margin = 10;

    let lampCount = 20;
    let lampSize = (canvasWidth - margin * 2) / lampCount;
    let lampDrawSize = lampSize * 0.8

    let safeLamp = 125;
    let warnLamp = 0;
    let highBright = 100;
    let lowBright = 20;

    function setup() {
      createCanvas(canvasWidth, canvasHeight);

      noStroke();
      colorMode(HSB);

      mic = new p5.AudioIn();
      mic.start();
    }

    function draw() {
      background(0);

      let vol = mic.getLevel() * lampCount * 0.8;
      let onLampCount = vol > lampCount ? lampCount : Math.floor(vol);
      let fraction = vol - onLampCount;

      var brights = Array(onLampCount).fill(highBright)
        .concat( (f => {
          as = Array(lampCount - onLampCount).fill(lowBright);
          if (as.length > 0) { as[0] = f; } return as;
        })((1 - fraction) * lowBright + fraction * highBright));

      var x = margin - (lampSize / 2);
      brights.forEach( (v, i) => {
        fill((i < Math.floor(lampCount * 0.8) ? safeLamp : warnLamp), 100, v);
        x = x + lampSize;
        let y = canvasHeight / 2;
        ellipse(x, y, lampDrawSize, lampDrawSize);
      });
    }
  </script>
  </body>
</html>
